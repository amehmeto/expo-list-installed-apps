name: CI

on:
  push:
    branches: [master, develop]
  pull_request:
    types: [opened, synchronize, reopened, closed]

permissions:
  contents: write

jobs:
  typescript:
    name: TypeScript & Lint
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: TypeScript check
        run: npx tsc --noEmit

      - name: Build module
        run: npm run build

      - name: Run tests
        run: npm test

  android:
    name: Android Build
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install npm dependencies
        run: npm ci

      - name: Install example dependencies
        working-directory: ./example
        run: npm ci

      - name: Generate Android project (expo prebuild)
        working-directory: ./example
        run: npx expo prebuild --platform android --no-install

      - name: Run Kotlin unit tests
        working-directory: ./example/android
        run: ./gradlew :amehmeto-expo-list-installed-apps:testDebugUnitTest

      - name: Build example Android app (release)
        working-directory: ./example/android
        run: ./gradlew assembleRelease

      - name: Rename APK
        run: |
          mv example/android/app/build/outputs/apk/release/app-release.apk \
             example/android/app/build/outputs/apk/release/expo-list-installed-apps.apk

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: expo-list-installed-apps
          path: example/android/app/build/outputs/apk/release/expo-list-installed-apps.apk
          retention-days: 30

      - name: Create PR release
        id: create_release
        if: github.event_name == 'pull_request'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: pr-${{ github.event.pull_request.number }}-${{ github.sha }}
          name: "List Installed Apps Example APK - PR #${{ github.event.pull_request.number }}"
          body: |
            Automated build of the **List Installed Apps** example app for PR #${{ github.event.pull_request.number }}.

            **Commit:** ${{ github.sha }}
            **Branch:** ${{ github.head_ref }}

            Download the APK below to test the changes.
          files: example/android/app/build/outputs/apk/release/expo-list-installed-apps.apk
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send Slack notification
        if: github.event_name == 'pull_request' && success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          BRANCH: ${{ github.head_ref }}
          COMMIT_SHA: ${{ github.sha }}
          TAG_NAME: pr-${{ github.event.pull_request.number }}-${{ github.sha }}
          DOWNLOAD_URL: ${{ github.server_url }}/${{ github.repository }}/releases/download/pr-${{ github.event.pull_request.number }}-${{ github.sha }}/expo-list-installed-apps.apk
        run: bash scripts/send-slack-notification.sh

  cleanup-pr-releases:
    name: Cleanup PR Releases
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cleanup PR build releases
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          echo "Cleaning up releases for PR #${PR_NUMBER}"

          # List all releases matching the PR pattern
          RELEASES=$(gh release list --limit 1000 | grep "pr-${PR_NUMBER}-" | awk '{print $1}' || true)

          if [ -z "$RELEASES" ]; then
            echo "No releases found for PR #${PR_NUMBER}"
            exit 0
          fi

          # Delete each release
          echo "$RELEASES" | while read -r TAG; do
            if [ -n "$TAG" ]; then
              echo "Deleting release: $TAG"
              gh release delete "$TAG" --yes --cleanup-tag || true
            fi
          done

          echo "Cleanup complete for PR #${PR_NUMBER}"
